#!/usr/bin/env bash
# spec-loop entrypoint wrapper for the Rust engine
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  LINK_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
  LINK_TARGET="$(readlink "$SCRIPT_PATH")"
  if [[ "$LINK_TARGET" == /* ]]; then
    SCRIPT_PATH="$LINK_TARGET"
  else
    SCRIPT_PATH="$LINK_DIR/$LINK_TARGET"
  fi
done

SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

if [[ -n "${SPEC_LOOP_BIN:-}" ]]; then
  exec "${SPEC_LOOP_BIN}" "$@"
fi

if [[ -x "${ROOT_DIR}/target/release/spec-loop" ]]; then
  exec "${ROOT_DIR}/target/release/spec-loop" "$@"
fi

if [[ -x "${ROOT_DIR}/target/debug/spec-loop" ]]; then
  exec "${ROOT_DIR}/target/debug/spec-loop" "$@"
fi

if command -v cargo >/dev/null 2>&1; then
  cargo build --quiet --manifest-path "${ROOT_DIR}/Cargo.toml" --bin spec-loop
  exec "${ROOT_DIR}/target/debug/spec-loop" "$@"
fi

echo "spec-loop binary not found and cargo is not installed." >&2
echo "Build with: cargo build --release" >&2
exit 1
